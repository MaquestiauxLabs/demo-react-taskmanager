name: Move Issue to In Progress When Work Starts

on:
  create:
  push:
    branches:
      - "**"
  pull_request:
    types: [opened, synchronize, reopened]

jobs:
  set-in-progress:
    runs-on: ubuntu-latest

    steps:
      - name: Extract issue number from branch name
        id: extract
        run: |
          BRANCH="${GITHUB_REF#refs/heads/}"
          # Expecting branch names like: username/issue2
          ISSUE_NUMBER=$(echo "$BRANCH" | grep -oE 'issue[0-9]+' | grep -oE '[0-9]+')
          echo "branch=$BRANCH"
          echo "issue=$ISSUE_NUMBER"
          echo "issue_number=$ISSUE_NUMBER" >> $GITHUB_OUTPUT

      - name: Stop if no issue number found
        if: steps.extract.outputs.issue_number == ''
        run: echo "No issue number found in branch name. Skipping."

      - name: Update project status to In Progress
        if: steps.extract.outputs.issue_number != ''
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          ISSUE_NUMBER: ${{ steps.extract.outputs.issue_number }}
        run: |
          set -euo pipefail

          PROJECT_ID="PVT_kwDOD2nfkc4BPmHI"

          # 1) Find this issue's project item in the target project
          ITEM_ID=$(gh api graphql -f query='
            query($owner:String!, $repo:String!, $issue:Int!) {
              repository(owner:$owner, name:$repo) {
                issue(number:$issue) {
                  projectItems(first:20) {
                    nodes {
                      id
                      project { id }
                    }
                  }
                }
              }
            }' -f owner="${GITHUB_REPOSITORY%/*}" -f repo="${GITHUB_REPOSITORY#*/}" -F issue="$ISSUE_NUMBER" | \
            jq -r ".data.repository.issue.projectItems.nodes[] | select(.project.id == \"$PROJECT_ID\") | .id" | head -n1 || true)

          if [ -z "${ITEM_ID:-}" ]; then
            echo "Issue #$ISSUE_NUMBER is not in project $PROJECT_ID. Skipping update."
            exit 0
          fi

          # 2) Resolve field/option IDs for Status -> In Progress
          PROJECT_FIELDS=$(gh api graphql -f query='
            query($project:ID!) {
              node(id:$project) {
                ... on ProjectV2 {
                  fields(first:50) {
                    nodes {
                      ... on ProjectV2SingleSelectField {
                        id
                        name
                        options {
                          id
                          name
                        }
                      }
                    }
                  }
                }
              }
            }' -f project="$PROJECT_ID")

          STATUS_FIELD_ID=$(echo "$PROJECT_FIELDS" | jq -r '.data.node.fields.nodes[] | select(.name == "Status") | .id' | head -n1)
          IN_PROGRESS_OPTION_ID=$(echo "$PROJECT_FIELDS" | jq -r '.data.node.fields.nodes[] | select(.name == "Status") | .options[] | select(.name == "In Progress") | .id' | head -n1)

          if [ -z "${STATUS_FIELD_ID:-}" ] || [ "$STATUS_FIELD_ID" = "null" ]; then
            echo "Status field not found in project $PROJECT_ID. Skipping update."
            exit 0
          fi

          if [ -z "${IN_PROGRESS_OPTION_ID:-}" ] || [ "$IN_PROGRESS_OPTION_ID" = "null" ]; then
            echo "In Progress option not found in Status field. Skipping update."
            exit 0
          fi

          # 3) Update the project's Status field to In Progress
          gh api graphql -f query='
            mutation($item:ID!, $project:ID!, $field:ID!, $option:String!) {
              updateProjectV2ItemFieldValue(
                input: {
                  projectId: $project,
                  itemId: $item,
                  fieldId: $field,
                  value: { singleSelectOptionId: $option }
                }
              ) {
                projectV2Item { id }
              }
            }' \
            -f item="$ITEM_ID" \
            -f project="$PROJECT_ID" \
            -f field="$STATUS_FIELD_ID" \
            -f option="$IN_PROGRESS_OPTION_ID"
